<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ ä¼šè¯Šç—…å†ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        .consultation-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        .input-panel,
        .output-panel {
            flex: 1;
            background: linear-gradient(135deg, rgba(20, 30, 48, 0.95) 0%, rgba(36, 59, 85, 0.9) 100%);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.3rem;
            color: #fff;
        }

        .dialogue-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .dialogue-item {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: flex-start;
        }

        .dialogue-item select {
            width: 80px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .dialogue-item input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        .dialogue-item input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .dialogue-item .remove-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 100, 100, 0.3);
            color: #fff;
            cursor: pointer;
            transition: background 0.3s;
        }

        .dialogue-item .remove-btn:hover {
            background: rgba(255, 100, 100, 0.5);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-add,
        .btn-generate,
        .btn-clear {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .btn-add:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .btn-generate {
            background: linear-gradient(135deg, #00d4aa 0%, #00a8cc 100%);
            color: #fff;
            flex: 1;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-clear {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        .soap-content {
            flex: 1;
            overflow-y: auto;
        }

        .soap-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .soap-section h3 {
            margin: 0 0 10px 0;
            color: #00d4aa;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .soap-section p {
            margin: 0;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
        }

        .entities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .entity-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            background: rgba(0, 212, 170, 0.2);
            color: #00d4aa;
        }

        .entity-tag.symptom {
            background: rgba(255, 150, 100, 0.2);
            color: #ff9664;
        }

        .entity-tag.disease {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }

        .entity-tag.medication {
            background: rgba(100, 150, 255, 0.2);
            color: #6496ff;
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
        }

        .loading-indicator.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-link:hover {
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>

    <div class="consultation-container">
        <!-- è¾“å…¥é¢æ¿ -->
        <div class="input-panel">
            <div class="panel-header">
                <span style="font-size: 24px;">ğŸ“</span>
                <h2>å¯¹è¯è®°å½•è¾“å…¥</h2>
            </div>

            <div class="dialogue-list" id="dialogue-list">
                <!-- å¯¹è¯æ¡ç›®å°†åŠ¨æ€æ·»åŠ  -->
            </div>

            <div class="action-buttons">
                <button class="btn-add" onclick="addDialogueItem()">+ æ·»åŠ å¯¹è¯</button>
                <button class="btn-clear" onclick="clearDialogue()">æ¸…ç©º</button>
                <button class="btn-generate" id="generate-btn" onclick="generateSOAP()">ğŸ”¬ ç”Ÿæˆç—…å†</button>
            </div>
        </div>

        <!-- è¾“å‡ºé¢æ¿ -->
        <div class="output-panel">
            <div class="panel-header">
                <span style="font-size: 24px;">ğŸ“‹</span>
                <h2>SOAP ç—…å†</h2>
            </div>

            <div class="soap-content" id="soap-content">
                <div class="empty-state">
                    <div class="icon">ğŸ“„</div>
                    <p>è¾“å…¥å¯¹è¯è®°å½•åç‚¹å‡»"ç”Ÿæˆç—…å†"</p>
                </div>
            </div>

            <div class="loading-indicator" id="loading">
                <div class="loading-dots">
                    <span></span><span></span><span></span>
                </div>
                <p>æ­£åœ¨ç”Ÿæˆç—…å†...</p>
            </div>
        </div>
    </div>

    <script>
        let dialogueCount = 0;

        // é¡µé¢åŠ è½½æ—¶æ·»åŠ åˆå§‹å¯¹è¯æ¡ç›®
        window.onload = function () {
            addDialogueItem('åŒ»ç”Ÿ', 'æ‚¨å¥½ï¼Œè¯·é—®å“ªé‡Œä¸èˆ’æœï¼Ÿ');
            addDialogueItem('æ‚£è€…', '');
        };

        function addDialogueItem(role = 'æ‚£è€…', text = '') {
            dialogueCount++;
            const list = document.getElementById('dialogue-list');
            const item = document.createElement('div');
            item.className = 'dialogue-item';
            item.id = `dialogue-${dialogueCount}`;
            item.innerHTML = `
                <select>
                    <option value="åŒ»ç”Ÿ" ${role === 'åŒ»ç”Ÿ' ? 'selected' : ''}>åŒ»ç”Ÿ</option>
                    <option value="æ‚£è€…" ${role === 'æ‚£è€…' ? 'selected' : ''}>æ‚£è€…</option>
                    <option value="å®¶å±" ${role === 'å®¶å±' ? 'selected' : ''}>å®¶å±</option>
                </select>
                <input type="text" placeholder="è¾“å…¥å¯¹è¯å†…å®¹..." value="${text}">
                <button class="remove-btn" onclick="removeDialogueItem(${dialogueCount})">âœ•</button>
            `;
            list.appendChild(item);

            // èšç„¦åˆ°æ–°æ·»åŠ çš„è¾“å…¥æ¡†
            if (!text) {
                item.querySelector('input').focus();
            }
        }

        function removeDialogueItem(id) {
            const item = document.getElementById(`dialogue-${id}`);
            if (item) {
                item.remove();
            }
        }

        function clearDialogue() {
            document.getElementById('dialogue-list').innerHTML = '';
            dialogueCount = 0;
            addDialogueItem('åŒ»ç”Ÿ', '');
        }

        function getDialogueData() {
            const items = document.querySelectorAll('.dialogue-item');
            const utterances = [];
            items.forEach(item => {
                const role = item.querySelector('select').value;
                const text = item.querySelector('input').value.trim();
                if (text) {
                    utterances.push({ speaker: role, text: text });
                }
            });
            return utterances;
        }

        async function generateSOAP() {
            const utterances = getDialogueData();
            if (utterances.length === 0) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€æ¡å¯¹è¯å†…å®¹');
                return;
            }

            const btn = document.getElementById('generate-btn');
            const loading = document.getElementById('loading');
            const content = document.getElementById('soap-content');

            btn.disabled = true;
            loading.classList.add('active');
            content.style.display = 'none';

            try {
                const response = await fetch('/aci/generate-soap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ utterances: utterances })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                displaySOAP(data.soap);
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âŒ</div>
                        <p>ç”Ÿæˆå¤±è´¥: ${error.message}</p>
                    </div>
                `;
                content.style.display = 'block';
            } finally {
                btn.disabled = false;
                loading.classList.remove('active');
            }
        }

        function displaySOAP(soap) {
            const content = document.getElementById('soap-content');

            let html = '';

            // S - Subjective
            html += `
                <div class="soap-section">
                    <h3>ğŸ“Œ S - ä¸»è¯‰ (Subjective)</h3>
                    <p>${soap.subjective?.chief_complaint || soap.subjective?.content || 'æš‚æ— è®°å½•'}</p>
                    ${soap.subjective?.history ? `<p style="margin-top:10px;color:rgba(255,255,255,0.6);">ç—…å²: ${soap.subjective.history}</p>` : ''}
                </div>
            `;

            // O - Objective
            html += `
                <div class="soap-section">
                    <h3>ğŸ”¬ O - å®¢è§‚æ£€æŸ¥ (Objective)</h3>
                    <p>${soap.objective?.vital_signs || soap.objective?.content || 'æš‚æ— æ£€æŸ¥è®°å½•'}</p>
                </div>
            `;

            // A - Assessment
            html += `
                <div class="soap-section">
                    <h3>ğŸ©º A - è¯„ä¼° (Assessment)</h3>
                    <p>${soap.assessment?.diagnosis || soap.assessment?.content || 'å¾…è¯„ä¼°'}</p>
                </div>
            `;

            // P - Plan
            html += `
                <div class="soap-section">
                    <h3>ğŸ“‹ P - æ²»ç–—è®¡åˆ’ (Plan)</h3>
                    <p>${soap.plan?.treatment || soap.plan?.content || 'å¾…åˆ¶å®š'}</p>
                </div>
            `;

            // æå–çš„å®ä½“
            if (soap.entities && soap.entities.length > 0) {
                html += `
                    <div class="soap-section">
                        <h3>ğŸ·ï¸ è¯†åˆ«çš„åŒ»å­¦å®ä½“</h3>
                        <div class="entities-list">
                            ${soap.entities.map(e => `<span class="entity-tag ${e.type}">${e.text}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            content.style.display = 'block';
        }
    </script>
</body>

</html>