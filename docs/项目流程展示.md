# 🏥 智能医疗语音助手系统 - 项目流程展示

---

## 📋 项目概述

本项目是一个**端到端的智能医疗语音对话系统**，集成了语音识别、情感分析、声纹识别、大语言模型对话、知识图谱问答、RAG知识检索和语音合成等多项 AI 技术，专为医疗场景设计。

### 🎯 核心目标

- **患者端**：提供智能导诊、症状咨询、用药查询等服务
- **医生端**：提供辅助诊断、病历生成（SOAP）、用药管理等功能
- **全程语音交互**：支持唤醒词、连续对话、情感识别，老年人友好

---

## 🏗️ 系统架构图

```
                           ┌─────────────────────────────────────┐
                           │       智能医疗语音助手系统           │
                           └─────────────────────────────────────┘
                                            │
              ┌─────────────────────────────┴─────────────────────────────┐
              │                                                           │
              ▼                                                           ▼
┌─────────────────────────┐                           ┌─────────────────────────────┐
│   🍓 客户端 (树莓派)     │         HTTP/SSE          │      🖥️ 服务端 (Flask)       │
│─────────────────────────│◄────────────────────────►│─────────────────────────────│
│ • 麦克风阵列 (6-Mic)    │                           │ • RESTful API              │
│ • 声源定位 (DOA)       │                           │ • 流式音频传输              │
│ • 波束成形 (Beamforming)│                           │ • SSE 消息推送              │
│ • 回声消除 (AEC)       │                           │ • Web 界面                 │
│ • VAD 语音检测         │                           └─────────────────────────────┘
│ • 唤醒词检测           │                                        │
│ • 流式音频播放         │                                        ▼
└─────────────────────────┘               ┌────────────────────────────────────────────┐
                                          │           核心 AI 模块                      │
                                          │────────────────────────────────────────────│
                                          │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
                                          │  │   ASR    │  │   TTS    │  │ Dialogue │  │
                                          │  │SenseVoice│  │CosyVoice │  │Qwen/GPTQ │  │
                                          │  └──────────┘  └──────────┘  └──────────┘  │
                                          │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
                                          │  │ Emotion  │  │ Speaker  │  │   RAG    │  │
                                          │  │情感识别   │  │声纹识别   │  │向量检索   │  │
                                          │  └──────────┘  └──────────┘  └──────────┘  │
                                          └────────────────────────────────────────────┘
                                                           │
                                          ┌────────────────┴────────────────┐
                                          ▼                                  ▼
                          ┌───────────────────────────┐    ┌───────────────────────────┐
                          │       医疗业务模块          │    │     临床智能 (ACI)         │
                          │───────────────────────────│    │───────────────────────────│
                          │ • 患者导诊 (Triage)       │    │ • SOAP病历生成            │
                          │ • 辅助诊断 (Diagnosis)    │    │ • 临床实体提取             │
                          │ • 用药管理 (Medication)   │    │ • 急救检测                │
                          │ • 意图分类 (Intent)       │    │ • 幻觉检测                │
                          │ • 知识图谱 (Neo4j)        │    │ • 说话人分离              │
                          └───────────────────────────┘    └───────────────────────────┘
```

---

## 🔄 完整对话流程图

```
用户说话 ──────────────────────────────────────────────────────────────────────────────────►

┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Step 1  │───►│  Step 2  │───►│  Step 3  │───►│  Step 4  │───►│  Step 5  │───►│  Step 6  │
│ 音频采集  │    │ 语音识别  │    │ 多模态分析│    │ 对话生成  │    │ 语音合成  │    │ 音频播放  │
│──────────│    │──────────│    │──────────│    │──────────│    │──────────│    │──────────│
│ • VAD    │    │SenseVoice│    │ • 情感   │    │ • RAG    │    │CosyVoice │    │ 流式播放  │
│ • 录音   │    │ 50+语言  │    │ • 声纹   │    │ • 知识图谱│    │ 音色克隆  │    │ 边生成   │
│ • 唤醒词  │    │ 自动检测  │    │ • 意图   │    │ • LLM    │    │ 情感风格  │    │ 边播放   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
     │                │                │                │                │                │
     ▼                ▼                ▼                ▼                ▼                ▼
 ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐
 │ 客户端  │      │ 服务端  │      │ 服务端  │      │ 服务端  │      │ 服务端  │      │ 客户端  │
 └────────┘      └────────┘      └────────┘      └────────┘      └────────┘      └────────┘

◄────────────────────────────────────────────────────────────────────────────── 系统回复
```

---

## 🧩 核心模块详解

### 1️⃣ 语音识别模块 (ASR)

| 属性 | 说明 |
|:---:|:---|
| **模型** | SenseVoice (阿里达摩院) |
| **功能** | 语音转文字、语言检测、情感识别、音频事件检测 |
| **语言** | 支持50+语言/方言（中文、英语、日语、韩语、粤语等） |
| **特点** | 一次推理同时输出：文本 + 语言 + 情感 + 事件 |

```
输入音频 ──► SenseVoice ──► 输出格式：<|zh|><|HAPPY|><|Speech|><|woitn|>你好医生...
                              │            │         │          │          │
                              └──语言标签───┴──情感───┴──事件────┴──模式────┴──文本
```

### 2️⃣ 语音合成模块 (TTS)

| 属性 | 说明 |
|:---:|:---|
| **模型** | CosyVoice-300M-Instruct (阿里达摩院) |
| **功能** | 文字转语音、音色克隆、情感表达、流式输出 |
| **特点** | 支持 Instruct 模式（自然语言控制语音风格） |
| **流式** | 边生成边返回，首音频延迟 < 1秒 |

```
支持的情感/风格指令：
┌─────────────────────────────────────────────────────┐
│ "用温和关心的语气说"  "用专业严肃的语气说"           │
│ "用轻松愉快的语气说"  "用安慰鼓励的语气说"           │
└─────────────────────────────────────────────────────┘
```

### 3️⃣ 对话生成模块 (Dialogue)

| 配置 | 说明 |
|:---:|:---|
| **模型** | Qwen3-8B-SFT-Huatuo (医疗微调) |
| **量化** | GPTQ W4A16（节省显存） |
| **上下文** | 支持多轮对话历史 |
| **增强** | RAG知识检索 + 知识图谱 |

```
对话生成流程：
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 用户输入 │─────►│ 意图分类 │─────►│ 知识增强 │─────►│ LLM生成 │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
                      │                │
                      ▼                ▼
              ┌──────────────┐  ┌──────────────┐
              │ 模式切换判断   │  │ RAG + 知识图谱│
              │患者/医生/会诊  │  │  检索相关知识  │
              └──────────────┘  └──────────────┘
```

### 4️⃣ RAG 知识检索模块

| 属性 | 说明 |
|:---:|:---|
| **嵌入模型** | BGE-Small-ZH-v1.5 |
| **向量库** | FAISS |
| **文档数量** | 17万+ 医疗文档 |
| **检索方式** | 语义相似度匹配 |

```
RAG 检索流程：
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 用户问题 │─────►│ 向量编码 │─────►│FAISS检索│─────►│Top-K文档│
└─────────┘      └─────────┘      └─────────┘      └─────────┘
                                                        │
                                                        ▼
                                              ┌─────────────────┐
                                              │ 拼接为 Prompt    │
                                              │ 送入 LLM 生成    │
                                              └─────────────────┘
```

### 5️⃣ 知识图谱模块 (Neo4j)

| 实体类型 | 数量 | 说明 |
|:---:|:---:|:---|
| 疾病 | ~8,000 | 疾病名称、别名 |
| 症状 | ~5,000 | 症状描述 |
| 药物 | ~4,000 | 药品信息 |
| 科室 | ~50 | 医院科室 |
| 检查 | ~500 | 检查项目 |

```
知识图谱结构示例：
              ┌───────────────┐
              │    感冒        │
              │   (Disease)   │
              └───────────────┘
                /     |     \
            has_     need_   common_
           symptom   drug    department
              /       |        \
    ┌─────────┐  ┌─────────┐  ┌─────────┐
    │  发烧    │  │ 布洛芬   │  │ 内科    │
    │(Symptom)│  │ (Drug)  │  │(Depart.)│
    └─────────┘  └─────────┘  └─────────┘
```

---

## 🏥 医疗功能模块

### 患者模式功能

```
┌─────────────────────────────────────────────────────────────────────┐
│                        患者智能导诊流程                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  用户输入       意图识别           症状提取          知识检索          │
│  ┌─────┐      ┌─────────┐       ┌─────────┐      ┌─────────┐       │
│  │"我头│─────►│症状咨询 │──────►│ 头痛    │─────►│RAG+知识 │       │
│  │疼..." │     │导诊需求 │       │ (提取)  │      │图谱查询  │       │
│  └─────┘      └─────────┘       └─────────┘      └─────────┘       │
│                                                       │              │
│                                                       ▼              │
│                                              ┌─────────────────┐    │
│                                              │ 生成导诊建议：    │    │
│                                              │ • 推荐科室：神经内科│    │
│                                              │ • 可能疾病：...   │    │
│                                              │ • 注意事项：...   │    │
│                                              └─────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

### 医生模式功能

```
┌─────────────────────────────────────────────────────────────────────┐
│                        医生辅助诊断流程                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  症状描述           实体提取           知识检索           诊断建议    │
│  ┌─────────┐      ┌─────────┐       ┌─────────┐      ┌─────────┐   │
│  │患者38℃ │─────►│ 发热    │──────►│鉴别诊断 │─────►│可能诊断  │   │
│  │咳嗽3天...│     │ 咳嗽    │       │知识库   │      │检查项目  │   │
│  └─────────┘      └─────────┘       └─────────┘      │治疗方案  │   │
│                                                       └─────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### SOAP病历生成

```
┌─────────────────────────────────────────────────────────────────────┐
│                     SOAP 病历自动生成                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  对话记录                    实体提取                   SOAP格式     │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐ │
│  │医生：哪里不舒服│─────────►│ 临床实体    │─────────►│ S: 主诉     │ │
│  │患者：头疼发烧 │          │ • 症状      │          │ O: 客观检查  │ │
│  │医生：体温多少 │          │ • 体征      │          │ A: 诊断评估  │ │
│  │患者：38.5度  │          │ • 检查结果   │          │ P: 治疗计划  │ │
│  └─────────────┘          └─────────────┘          └─────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🎤 声学前端（麦克风阵列）

```
                    ReSpeaker 6-Mic 环形麦克风阵列
                    
                           0° (Mic 0)
                              ●
                          /       \
                   300°  ●         ●  60°
                  (Mic 5)           (Mic 1)
                        |           |
                  240°  ●    ▣     ●  120°
                  (Mic 4)   LED    (Mic 2)
                          \       /
                              ●
                           180° (Mic 3)

┌─────────────────────────────────────────────────────────────────────┐
│ 信号处理流程：                                                        │
│                                                                      │
│  6通道音频 ──► DOA声源定位 ──► 波束成形 ──► 回声消除 ──► VAD检测 ──► 输出│
│              (GCC-PHAT)    (DAS/MVDR)    (NLMS)                     │
│                                                                      │
│ 功能说明：                                                            │
│ • DOA：检测说话人方向（360°，1°分辨率）                                  │
│ • 波束成形：增强目标方向信号，抑制噪声                                    │
│ • 回声消除：消除扬声器播放的回声                                         │
│ • VAD：检测语音活动，自动开始/结束录音                                   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📡 API 接口结构

### 核心 API 端点

| 类别 | 端点 | 方法 | 功能 |
|:---:|:---|:---:|:---|
| **语音处理** | `/asr` | POST | 语音识别（含情感、语言检测） |
| | `/tts` | POST | 语音合成 |
| | `/tts/stream` | POST | 流式语音合成 |
| **对话** | `/chat` | POST | 完整对话流程（ASR→情感→声纹→对话→TTS） |
| | `/dialogue` | POST | 纯文本对话 |
| **声纹** | `/speaker/register` | POST | 注册声纹 + 音色克隆 |
| | `/speaker/recognize` | POST | 声纹识别 |
| **医疗** | `/patient/triage` | POST | 患者导诊 |
| | `/doctor/analyze-symptoms` | POST | 医生辅助诊断 |
| | `/medication/query` | POST | 药品查询 |
| **ACI** | `/consultation/start` | POST | 开始会诊 |
| | `/aci/generate-soap` | POST | 生成SOAP病历 |
| | `/emergency/assess` | POST | 急救评估 |

### /chat 完整对话流程

```
                              /chat API 内部流程
                              
Request (音频文件) ─────────────────────────────────────────────────────►
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. ASR 语音识别                                                     │
│     ├── 语音转文字                                                   │
│     ├── 语言检测                                                     │
│     └── 情感识别                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  2. 声纹识别（可选）                                                  │
│     └── 识别用户身份                                                 │
├─────────────────────────────────────────────────────────────────────┤
│  3. 意图分类                                                         │
│     ├── 模式切换检测（患者/医生/会诊）                                  │
│     └── 语音命令处理                                                 │
├─────────────────────────────────────────────────────────────────────┤
│  4. 知识增强                                                         │
│     ├── RAG 向量检索                                                 │
│     └── Neo4j 知识图谱查询                                           │
├─────────────────────────────────────────────────────────────────────┤
│  5. LLM 对话生成                                                     │
│     └── 基于增强上下文生成回复                                        │
├─────────────────────────────────────────────────────────────────────┤
│  6. TTS 语音合成                                                     │
│     ├── 情感匹配                                                     │
│     └── 音色克隆（可选）                                              │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
Response (音频 + 元数据) ◄─────────────────────────────────────────────
```

---

## 🛠️ 技术栈汇总

| 类别 | 技术/模型 |
|:---|:---|
| **后端框架** | Flask, Flask-CORS |
| **深度学习** | PyTorch, Transformers, FunASR |
| **语音识别** | SenseVoice (FunASR) |
| **语音合成** | CosyVoice-300M-Instruct |
| **大语言模型** | Qwen3-8B (GPTQ量化, Huatuo医疗微调) |
| **向量检索** | FAISS + BGE-Small-ZH-v1.5 |
| **知识图谱** | Neo4j + py2neo |
| **实体识别** | AC自动机 (pyahocorasick) |
| **音频处理** | librosa, soundfile, PyAudio |
| **客户端** | Python + 树莓派 |

---

## 📊 性能指标

| 指标 | 数值 | 说明 |
|:---|:---:|:---|
| ASR 延迟 | < 500ms | 语音识别响应时间 |
| TTS 首音频延迟 | < 1s | 流式模式下首音频延迟 |
| 完整对话响应 | < 2s | ASR + 对话 + TTS 总延迟 |
| RAG 检索 | < 100ms | 向量检索响应时间 |
| 知识图谱查询 | < 200ms | Neo4j 查询响应时间 |
| 医疗文档量 | 17.7万+ | RAG 知识库文档数量 |
| 知识图谱实体 | 4.4万+ | 医学词典词条数量 |

---

## 🖥️ 部署架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          生产部署架构                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│            ┌───────────────────────────────────────┐                │
│            │           GPU 服务器                   │                │
│            │  ┌─────────────────────────────────┐  │                │
│            │  │         Flask Server            │  │                │
│            │  │  (6008端口, 支持多并发)           │  │                │
│            │  ├─────────────────────────────────┤  │                │
│            │  │  ASR  │  TTS  │  LLM  │  RAG   │  │                │
│            │  │  GPU  │  GPU  │  GPU  │  CPU   │  │                │
│            │  └─────────────────────────────────┘  │                │
│            │  ┌─────────────────────────────────┐  │                │
│            │  │         Neo4j (7474端口)         │  │                │
│            │  └─────────────────────────────────┘  │                │
│            └────────────────┬──────────────────────┘                │
│                             │                                        │
│                        HTTP/SSE                                      │
│                             │                                        │
│         ┌───────────────────┼───────────────────┐                   │
│         │                   │                   │                   │
│         ▼                   ▼                   ▼                   │
│   ┌───────────┐       ┌───────────┐       ┌───────────┐            │
│   │ 树莓派客户端│       │ Web浏览器 │       │ 移动终端   │            │
│   │ (麦克风阵列)│       │(测试/演示) │       │ (未来)    │            │
│   └───────────┘       └───────────┘       └───────────┘            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## ✨ 项目亮点

1. **端到端语音交互**：完整的语音识别→对话→语音合成流程
2. **医疗知识增强**：RAG + 知识图谱双重知识增强
3. **情感感知**：识别用户情感并调整回复风格
4. **音色克隆**：支持个性化音色定制
5. **流式TTS**：边生成边播放，降低延迟
6. **多角色支持**：患者/医生/会诊三种模式
7. **SOAP病历**：自动从对话生成结构化病历
8. **麦克风阵列**：专业级声学前端处理

---

## 🔮 未来展望

- [ ] 影像学报告解读
- [ ] 检验结果分析  
- [ ] 慢性病管理
- [ ] 移动端 App
- [ ] 电子病历系统对接
- [ ] 多模态诊断（图像+语音）

---

> 📝 **免责声明**：本系统仅供辅助参考，不能替代专业医生的诊断和治疗。

---

*Made with ❤️ for Medical AI*
