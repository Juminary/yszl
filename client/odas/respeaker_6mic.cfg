# ODAS ReSpeaker 6-Mic Circular Array 配置文件
# 用于 Raspberry Pi 5 + seeed-8mic-voicecard 驱动
#
# 参考: https://github.com/introlab/odas/wiki/Configuration-File
# 阵列规格: 6麦克风环形阵列, 半径 0.0463m

# ============================================================
# 全局参数
# ============================================================

raw: {
    
    fS = 16000;              # 采样率 (Hz)
    hopSize = 128;           # 帧移 (samples), 决定时间分辨率 8ms
    nBits = 32;              # 位深 (AC108 输出 32-bit)
    nChannels = 8;           # 总通道数 (6 mic + 2 loopback)
    
    # ALSA 设备接口
    interface: {
        type = "soundcard";
        card = 3;            # 需通过 arecord -l 确认实际card ID
        device = 0;
    };
    
};

# ============================================================
# 通道映射 - 仅使用 6 个麦克风通道
# ============================================================

mapping: {
    
    map = (0, 1, 2, 3, 4, 5);  # 排除 Channel 6-7 (loopback)
    
};

# ============================================================
# 麦克风阵列几何配置
# ReSpeaker 6-Mic: 6麦克风均匀分布在圆周上
# 半径 R = 0.0463m (4.63cm)
# 角度: 0°, 60°, 120°, 180°, 240°, 300°
# ============================================================

general: {
    
    epsilon = 1E-20;         # 数值稳定性
    
    # 麦克风坐标 (笛卡尔坐标系, 单位: 米)
    # x = R * cos(θ), y = R * sin(θ), z = 0
    mics = (
        # Mic 0: 0° (前方)
        { 
            mu = ( +0.0463, +0.0000, +0.0000 ); 
            sigma2 = ( +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000 );
            direction = ( +0.0000, +0.0000, +1.0000 );
            angle = ( 80.0, 100.0 );
        },
        # Mic 1: 60°
        { 
            mu = ( +0.0232, +0.0401, +0.0000 ); 
            sigma2 = ( +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000 );
            direction = ( +0.0000, +0.0000, +1.0000 );
            angle = ( 80.0, 100.0 );
        },
        # Mic 2: 120°
        { 
            mu = ( -0.0232, +0.0401, +0.0000 ); 
            sigma2 = ( +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000 );
            direction = ( +0.0000, +0.0000, +1.0000 );
            angle = ( 80.0, 100.0 );
        },
        # Mic 3: 180° (后方)
        { 
            mu = ( -0.0463, +0.0000, +0.0000 ); 
            sigma2 = ( +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000 );
            direction = ( +0.0000, +0.0000, +1.0000 );
            angle = ( 80.0, 100.0 );
        },
        # Mic 4: 240°
        { 
            mu = ( -0.0232, -0.0401, +0.0000 ); 
            sigma2 = ( +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000 );
            direction = ( +0.0000, +0.0000, +1.0000 );
            angle = ( 80.0, 100.0 );
        },
        # Mic 5: 300°
        { 
            mu = ( +0.0232, -0.0401, +0.0000 ); 
            sigma2 = ( +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000 );
            direction = ( +0.0000, +0.0000, +1.0000 );
            angle = ( 80.0, 100.0 );
        }
    );

    # 声速
    speedOfSound = 343.0;    # m/s
    
    # 声源数量限制
    nSeps = 4;               # 最大分离声源数
    nDelays = 8;             # 延迟估计数量
    
};

# ============================================================
# SSL (Sound Source Localization) - SRP-PHAT 声源定位
# ============================================================

ssl: {
    
    # 搜索空间 (水平面)
    nLevels = 2;             # 金字塔层级
    
    # 搜索半径 (米)
    interpRate = 8;          # 插值率
    
    # 能量阈值 (检测声源的最小能量)
    epsilon = 0.15;
    
    # PHAT 参数
    alphaS = 0.5;            # 平滑系数 (0-1, 越大越平滑)
    
    # 扫描配置
    scans = (
        {
            # 水平面扫描 (Azimuth 0-360°, Elevation 固定为 0)
            src = "sphere";
            
            # 扫描范围
            levels = (
                # Level 0: 粗扫描
                { 
                    resolution = 12;   # 360°/12 = 30° 分辨率
                    min = 0.0;
                    max = 360.0;
                },
                # Level 1: 精细扫描
                { 
                    resolution = 36;   # 10° 分辨率
                    min = 0.0;
                    max = 360.0;
                }
            );
        }
    );
    
};

# ============================================================
# SST (Sound Source Tracking) - 卡尔曼滤波跟踪
# ============================================================

sst: {
    
    # 卡尔曼滤波参数
    N_inactive = 10;         # 失活前的无检测帧数
    N_max = 4;               # 最大同时跟踪声源数
    
    # 过程噪声
    sigmaQ = 0.01;
    
    # 观测噪声
    sigmnaR = 0.2;
    
    # 跟踪阈值
    activityThreshold = 0.05;
    
    # 声源生命周期
    alpha = 0.5;             # 平滑因子
    beta = 0.1;              # 新源生成阈值
    
    # 输出接口 (JSON via Socket)
    interface: {
        type = "socket";
        ip = "127.0.0.1";
        port = 9000;
    };
    
    format = "json";
    
};

# ============================================================
# SSS (Sound Source Separation) - 波束成形分离
# ============================================================

sss: {
    
    # 分离模式
    mode = "dgbf";           # Dynamic Geometric Beamforming
    
    # 波束成形参数
    alphaPmin = 0.1;         # 最小后验概率
    mu = 0.01;               # 步长
    lambda = 0.5;            # 正则化
    
    # 输出接口 (原始音频 via Socket)
    # 每个分离的声源输出为单独的音频流
    interface: {
        type = "socket";
        ip = "127.0.0.1";
        port = 9001;
    };
    
    format = "json";         # 音频数据JSON封装
    
};

# ============================================================
# 延迟估计 (用于波束成形)
# ============================================================

delay: {
    
    # GCC-PHAT 参数
    nDelays = 16;            # 延迟搜索范围 (samples)
    interpRate = 8;          # 插值率
    
};
